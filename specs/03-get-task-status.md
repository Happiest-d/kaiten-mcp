# get-task-status

Отслеживание статусов задач в Kaiten.

## Цель

Позволяет AI-агенту быстро узнать текущий статус одной или нескольких задач (карточек) по их ID. Это базовая операция для мониторинга прогресса, построения отчётов и принятия решений на основе состояния задач.

## API

### MCP Tool Definition

```typescript
server.registerTool(
  'get-task-status',
  {
    title: 'Get Task Status',
    description: 'Получить текущий статус задачи (карточки) в Kaiten по ID. Поддерживает запрос статусов нескольких задач за один вызов.',
    inputSchema: z.object({
      card_ids: z.array(z.number().int().positive())
        .min(1)
        .max(50)
        .describe('Массив ID карточек. От 1 до 50 ID за один запрос.'),
    }),
  },
  async (params) => { /* ... */ }
);
```

### Входные данные

| Поле       | Тип        | Обязательное | Описание                          |
|------------|------------|--------------|-----------------------------------|
| `card_ids` | `number[]` | да           | Массив ID карточек (1-50 штук)    |

### Kaiten API эндпоинты

- `GET /api/latest/cards/{card_id}` — получение данных карточки (включая статус, колонку, доску)

Для нескольких карточек выполняются параллельные запросы. Переиспользуется метод `client.getCard()` из фичи get-task-details.

### Выходные данные

Массив объектов с информацией о статусе каждой карточки:

```typescript
interface TaskStatus {
  card_id: number;
  title: string;
  board_id: number;             // ID доски (число, не вложенный объект)
  column_id: number;            // ID колонки (число, не вложенный объект)
  state: string;                // маппинг из числового кода Kaiten API (1 = "active", ...)
  updated_at: string;           // ISO 8601 (маппинг из "updated" Kaiten API)
}
```

В случае ошибки для конкретной карточки возвращается объект с ошибкой:

```typescript
interface TaskStatusError {
  card_id: number;
  error: string;
}
```

Итоговый ответ — массив `(TaskStatus | TaskStatusError)[]`.

### Маппинг Kaiten API → MCP ответ

| Kaiten API поле | MCP выходное поле | Преобразование                     |
|-----------------|-------------------|------------------------------------|
| `id`            | `card_id`         | переименование                     |
| `title`         | `title`           | прямой                             |
| `board_id`      | `board_id`        | прямой                             |
| `column_id`     | `column_id`       | прямой                             |
| `state`         | `state`           | `mapState(state)` — число → строка |
| `updated`       | `updated_at`      | переименование                     |

## Сценарии

### Основные

1. **Запрос статуса одной задачи** — передаётся один ID, возвращается статус одной карточки.
2. **Запрос статусов нескольких задач** — передаётся массив ID, возвращаются статусы всех найденных карточек.
3. **Частичный успех** — часть карточек найдена, часть нет. Найденные возвращаются со статусом, ненайденные — с ошибкой `"Карточка не найдена"`. Используется `Promise.allSettled()`.

### Граничные случаи

4. **Пустой массив** — валидация zod отклоняет запрос (`min(1)`).
5. **Больше 50 ID** — валидация zod отклоняет запрос (`max(50)`).
6. **Несуществующая карточка** — Kaiten API возвращает 404, tool возвращает `TaskStatusError` для этого ID.
7. **Невалидный ID (отрицательное число, дробное)** — валидация zod отклоняет запрос.
8. **Ошибка авторизации** — Kaiten API возвращает 401, tool возвращает общую ошибку `"Ошибка авторизации. Проверьте KAITEN_API_TOKEN"`.
9. **Таймаут API** — tool возвращает ошибку `"Превышено время ожидания ответа от Kaiten API"`.

## Примеры

### Запрос статуса одной задачи

**Вход:**
```json
{
  "card_ids": [12345]
}
```

**Ответ (MCP content):**
```json
{
  "content": [
    {
      "type": "text",
      "text": "[{\"card_id\":12345,\"title\":\"Исправить баг в авторизации\",\"board_id\":10,\"column_id\":101,\"state\":\"active\",\"updated_at\":\"2026-02-10T14:30:00Z\"}]"
    }
  ]
}
```

### Запрос статусов нескольких задач

**Вход:**
```json
{
  "card_ids": [12345, 12346, 99999]
}
```

**Ответ (MCP content):**
```json
{
  "content": [
    {
      "type": "text",
      "text": "[{\"card_id\":12345,\"title\":\"Исправить баг в авторизации\",\"board_id\":10,\"column_id\":101,\"state\":\"active\",\"updated_at\":\"2026-02-10T14:30:00Z\"},{\"card_id\":12346,\"title\":\"Добавить пагинацию\",\"board_id\":10,\"column_id\":102,\"state\":\"active\",\"updated_at\":\"2026-02-09T18:00:00Z\"},{\"card_id\":99999,\"error\":\"Карточка не найдена\"}]"
    }
  ]
}
```

### Ошибка валидации (пустой массив)

**Вход:**
```json
{
  "card_ids": []
}
```

**Ответ (MCP error):**
```json
{
  "isError": true,
  "content": [
    {
      "type": "text",
      "text": "Ошибка валидации: card_ids должен содержать хотя бы 1 элемент"
    }
  ]
}
```
