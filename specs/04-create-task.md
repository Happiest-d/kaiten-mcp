# create-task

Создание задач (карточек) в Kaiten.

## Цель

Позволяет AI-агенту создавать новые задачи в Kaiten: указать заголовок, описание, назначить на доску и колонку, добавить теги. Это ключевая операция для автоматизации рабочих процессов — создание задач по результатам анализа, декомпозиция и планирование.

> **Ограничение Kaiten API:** Назначение ответственного (`owner_id`) и участников (`member_ids`) при создании карточки не поддерживается. Эти поля можно установить отдельным запросом после создания (вне скоупа данной фичи).

## API

### MCP Tool Definition

```typescript
server.registerTool(
  'create-task',
  {
    title: 'Create Task',
    description: 'Создать новую задачу (карточку) в Kaiten. Обязательные поля: заголовок, ID доски и ID колонки.',
    inputSchema: z.object({
      title: z.string()
        .min(1)
        .max(500)
        .describe('Заголовок задачи (1-500 символов)'),
      board_id: z.number().int().positive()
        .describe('ID доски, на которой создать карточку'),
      column_id: z.number().int().positive()
        .describe('ID колонки на доске'),
      description: z.string()
        .max(50000)
        .optional()
        .describe('Описание задачи (Markdown). До 50000 символов'),
      lane_id: z.number().int().positive()
        .optional()
        .describe('ID дорожки (lane) на доске'),
      position: z.union([z.literal(1), z.literal(2)])
        .optional()
        .describe('Позиция в колонке: 1 = в начало, 2 = в конец'),
      tags: z.array(z.number().int().positive())
        .max(20)
        .optional()
        .describe('ID тегов (до 20)'),
    }),
  },
  async (params) => { /* ... */ }
);
```

### Входные данные

| Поле          | Тип        | Обязательное | Описание                                       |
|---------------|------------|--------------|------------------------------------------------|
| `title`       | `string`   | да           | Заголовок задачи (1-500 символов)              |
| `board_id`    | `number`   | да           | ID доски                                       |
| `column_id`   | `number`   | да           | ID колонки                                     |
| `description` | `string`   | нет          | Описание (Markdown, до 50000 символов)         |
| `lane_id`     | `number`   | нет          | ID дорожки (lane) на доске                     |
| `position`    | `1 \| 2`   | нет          | Позиция: 1 = в начало, 2 = в конец колонки    |
| `tags`        | `number[]` | нет          | ID тегов (до 20)                               |

### Kaiten API эндпоинты

- `POST /api/latest/cards` — создание карточки

Тело запроса к Kaiten API:

```json
{
  "title": "Заголовок",
  "board_id": 10,
  "column_id": 101,
  "description": "Описание задачи",
  "lane_id": 5,
  "position": 2,
  "tags": [1, 2]
}
```

### Выходные данные

```typescript
interface CreatedTask {
  card_id: number;
  title: string;
  board_id: number;             // ID доски (число, не вложенный объект)
  column_id: number;            // ID колонки (число, не вложенный объект)
  lane_id: number | null;
  state: string;                // маппинг из числового кода Kaiten API
  created_at: string;           // ISO 8601 (маппинг из "created" Kaiten API)
}
```

### Маппинг Kaiten API → MCP ответ

| Kaiten API поле | MCP выходное поле | Преобразование                     |
|-----------------|-------------------|------------------------------------|
| `id`            | `card_id`         | переименование                     |
| `title`         | `title`           | прямой                             |
| `board_id`      | `board_id`        | прямой                             |
| `column_id`     | `column_id`       | прямой                             |
| `lane_id`       | `lane_id`         | прямой                             |
| `state`         | `state`           | `mapState(state)` — число → строка |
| `created`       | `created_at`      | переименование                     |

## Сценарии

### Основные

1. **Создание минимальной задачи** — только заголовок, доска и колонка. Карточка создаётся с пустым описанием.
2. **Создание задачи с полным набором полей** — заголовок, описание, дорожка, позиция, теги.
3. **Создание задачи с Markdown-описанием** — описание содержит форматирование, списки, код.
4. **Создание задачи с позицией в начало колонки** — `position: 1`.

### Граничные случаи

5. **Пустой заголовок** — валидация zod отклоняет запрос (`min(1)`).
6. **Заголовок длиннее 500 символов** — валидация zod отклоняет запрос (`max(500)`).
7. **Несуществующая доска** — Kaiten API возвращает ошибку, tool возвращает `"Доска не найдена"`.
8. **Несуществующая колонка** — Kaiten API возвращает ошибку, tool возвращает `"Колонка не найдена"`.
9. **Колонка не принадлежит указанной доске** — Kaiten API возвращает ошибку, tool возвращает `"Колонка не принадлежит указанной доске"`.
10. **Невалидный position** — валидация zod отклоняет запрос (допускает только `1` или `2`).
11. **Ошибка авторизации** — Kaiten API возвращает 401, tool возвращает ошибку `"Ошибка авторизации. Проверьте KAITEN_API_TOKEN"`.
12. **Нет прав на создание карточек на доске** — Kaiten API возвращает 403, tool возвращает ошибку `"Нет прав на создание карточек на этой доске"`.

## Примеры

### Создание минимальной задачи

**Вход:**
```json
{
  "title": "Добавить валидацию email",
  "board_id": 10,
  "column_id": 100
}
```

**Ответ (MCP content):**
```json
{
  "content": [
    {
      "type": "text",
      "text": "{\"card_id\":12350,\"title\":\"Добавить валидацию email\",\"board_id\":10,\"column_id\":100,\"lane_id\":null,\"state\":\"active\",\"created_at\":\"2026-02-11T10:00:00Z\"}"
    }
  ]
}
```

### Создание задачи с полным набором полей

**Вход:**
```json
{
  "title": "Реализовать OAuth2 авторизацию",
  "board_id": 10,
  "column_id": 100,
  "description": "## Задача\n\nДобавить поддержку OAuth2 для входа через Google и GitHub.\n\n### Требования\n\n- Поддержка Google OAuth2\n- Поддержка GitHub OAuth2\n- Сохранение refresh token\n\n### Технические детали\n\nИспользовать библиотеку `passport.js`.",
  "lane_id": 5,
  "position": 2,
  "tags": [1, 3]
}
```

**Ответ (MCP content):**
```json
{
  "content": [
    {
      "type": "text",
      "text": "{\"card_id\":12351,\"title\":\"Реализовать OAuth2 авторизацию\",\"board_id\":10,\"column_id\":100,\"lane_id\":5,\"state\":\"active\",\"created_at\":\"2026-02-11T10:05:00Z\"}"
    }
  ]
}
```

### Ошибка — несуществующая доска

**Вход:**
```json
{
  "title": "Тестовая задача",
  "board_id": 99999,
  "column_id": 100
}
```

**Ответ (MCP error):**
```json
{
  "isError": true,
  "content": [
    {
      "type": "text",
      "text": "Доска не найдена"
    }
  ]
}
```

### Ошибка валидации — пустой заголовок

**Вход:**
```json
{
  "title": "",
  "board_id": 10,
  "column_id": 100
}
```

**Ответ (MCP error):**
```json
{
  "isError": true,
  "content": [
    {
      "type": "text",
      "text": "Ошибка валидации: title должен содержать хотя бы 1 символ"
    }
  ]
}
```
