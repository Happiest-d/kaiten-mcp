# Спецификация: update-task

## Цель

Реализовать MCP-tool `update-task` для обновления полей существующей карточки в Kaiten. Сейчас после создания задачи невозможно изменить описание, заголовок, переместить между колонками, переназначить исполнителя или изменить участников — это критичный пробел.

## API

### Kaiten API

**Endpoint:** `PATCH /cards/{cardId}`

**Тело запроса (все поля опциональные):**

```json
{
  "title": "Новый заголовок",
  "description": "Новое описание",
  "column_id": 123,
  "lane_id": 456,
  "owner_id": 789,
  "members": [101, 102],
  "tags": [201, 202]
}
```

**Ответ:** полная карточка после обновления (те же поля, что в `GET /cards/{id}`)

### MCP Tool Definition

```typescript
server.registerTool(
  'update-task',
  {
    title: 'Update Task',
    description: `Обновить поля существующей задачи (карточки) в Kaiten. Можно изменить заголовок, описание, колонку, лейн, исполнителя, участников и теги. Все параметры кроме card_id опциональны — передавайте только те поля, которые нужно изменить.

ВАЖНО:
- Нельзя переместить карточку между досками (board_id не поддерживается)
- Можно обновить несколько полей за один запрос
- API вернёт полную обновлённую карточку со всеми полями`,
    inputSchema: z.object({
      card_id: z.number().int().positive().describe('ID карточки для обновления'),
      title: z.string().min(1).max(500).optional().describe('Новый заголовок (1-500 символов)'),
      description: z.string().max(50000).optional().describe('Новое описание (до 50000 символов)'),
      column_id: z.number().int().positive().optional().describe('ID новой колонки (для перемещения)'),
      lane_id: z.number().int().positive().optional().describe('ID нового лейна (для перемещения)'),
      owner_id: z.number().int().positive().optional().describe('ID нового исполнителя'),
      members: z.array(z.number().int().positive()).max(20).optional().describe('Массив user_id участников (до 20)'),
      tags: z.array(z.number().int().positive()).max(20).optional().describe('Массив tag_id (до 20)'),
    }),
  },
  async (params) => {
    // реализация
  }
);
```

## Типы

```typescript
// Параметры обновления (в KaitenClient)
interface UpdateCardParams {
  title?: string;
  description?: string;
  column_id?: number;
  lane_id?: number;
  owner_id?: number;
  members?: number[];
  tags?: number[];
}

// Ответ API (используем существующий KaitenCard из types.ts)
```

## Сценарии

### 1. Обновление заголовка

**Вход:**
```json
{
  "card_id": 12345,
  "title": "Новый заголовок задачи"
}
```

**Ожидается:** карточка с обновлённым title

### 2. Обновление описания

**Вход:**
```json
{
  "card_id": 12345,
  "description": "Обновлённое описание задачи\n\nС несколькими строками"
}
```

**Ожидается:** карточка с обновлённым description

### 3. Перемещение в другую колонку

**Вход:**
```json
{
  "card_id": 12345,
  "column_id": 67890
}
```

**Ожидается:** карточка с новым column_id

### 4. Перемещение в другой лейн

**Вход:**
```json
{
  "card_id": 12345,
  "lane_id": 11111
}
```

**Ожидается:** карточка с новым lane_id

### 5. Переназначение исполнителя

**Вход:**
```json
{
  "card_id": 12345,
  "owner_id": 22222
}
```

**Ожидается:** карточка с новым owner_id

### 6. Изменение участников

**Вход:**
```json
{
  "card_id": 12345,
  "members": [101, 102, 103]
}
```

**Ожидается:** карточка с новым списком members

### 7. Изменение тегов

**Вход:**
```json
{
  "card_id": 12345,
  "tags": [201, 202]
}
```

**Ожидается:** карточка с новым списком tags

### 8. Комбинированное обновление

**Вход:**
```json
{
  "card_id": 12345,
  "title": "Задача переименована",
  "column_id": 67890,
  "owner_id": 22222,
  "tags": [201]
}
```

**Ожидается:** карточка со всеми обновлёнными полями

### 9. Ошибка: карточка не найдена

**Вход:**
```json
{
  "card_id": 99999999,
  "title": "Test"
}
```

**Ожидается:** `KaitenApiError` с сообщением "Card not found" (404)

### 10. Ошибка: нет доступа

**API:** возвращает 403

**Ожидается:** `KaitenApiError` с сообщением "Forbidden" (403)

### 11. Ошибка: только card_id (без других полей)

**Вход:**
```json
{
  "card_id": 12345
}
```

**Ожидается:** запрос не отправляется, т.к. нечего обновлять (или отправляется пустой PATCH, что валидно и вернёт текущую карточку без изменений)

## Примеры

### Пример 1: переименовать задачу и переместить в "Готово"

**Запрос:**
```json
{
  "card_id": 60941654,
  "title": "MCP: update-task реализован",
  "column_id": 5747563
}
```

**Ответ:**
```json
{
  "content": [{
    "type": "text",
    "text": "Задача успешно обновлена:\n\nID: 60941654\nЗаголовок: MCP: update-task реализован\nКолонка: 5747563\nДоска: 1660008\nСтатус: active\nОбновлено: 2026-02-12T20:00:00.000Z"
  }]
}
```

### Пример 2: переназначить исполнителя и добавить участников

**Запрос:**
```json
{
  "card_id": 60941654,
  "owner_id": 688236,
  "members": [688236, 123456]
}
```

**Ответ:**
```json
{
  "content": [{
    "type": "text",
    "text": "Задача успешно обновлена:\n\nID: 60941654\nИсполнитель: 688236\nУчастники: 688236, 123456\nОбновлено: 2026-02-12T20:01:00.000Z"
  }]
}
```

## План реализации

1. **Добавить метод `updateCard` в `KaitenClient`** (src/kaiten/client.ts)
   - Метод принимает `cardId: number` и `params: UpdateCardParams`
   - Отправляет `PATCH /cards/{cardId}` с телом из params
   - Возвращает обновлённую карточку (`KaitenCard`)
   - Обрабатывает ошибки (404, 403, 500)

2. **Создать tool** (src/tools/update-task.ts)
   - Экспортирует `registerUpdateTask(server, client)`
   - Регистрирует tool с описанной выше схемой
   - Вызывает `client.updateCard()`
   - Форматирует ответ в читаемый текст

3. **Написать тесты** (tests/)
   - `tests/kaiten/client.test.ts` — тесты для `updateCard`:
     - Успешное обновление одного поля
     - Успешное обновление нескольких полей
     - Ошибка 404 (карточка не найдена)
     - Ошибка 403 (нет доступа)
     - Ошибка сети
   - `tests/tools/update-task.test.ts` — тесты для tool:
     - Обновление title
     - Обновление description
     - Перемещение (column_id)
     - Перемещение (lane_id)
     - Переназначение (owner_id)
     - Изменение members
     - Изменение tags
     - Комбинированное обновление
     - Ошибка от клиента

4. **Интегрировать tool в сервер** (src/server.ts)
   - Импортировать и вызвать `registerUpdateTask(server, client)`

5. **Обновить документацию**
   - `STATUS.md` — статус фичи, количество тестов
   - `MANUAL.md` — описание tool, параметры, примеры

## Критерии готовности

- ✅ Метод `updateCard` реализован в `KaitenClient`
- ✅ Tool `update-task` зарегистрирован
- ✅ Все тесты зелёные (минимум 9+)
- ✅ Покрыты все сценарии из списка
- ✅ Код прошёл линтер
- ✅ `STATUS.md` обновлён
- ✅ `MANUAL.md` обновлён
- ✅ Коммит создан

## Примечания

- Параметр `board_id` НЕ поддерживается API — карточки не перемещаются между досками через PATCH
- Все опциональные параметры можно комбинировать в одном запросе
- API возвращает полную обновлённую карточку, что позволяет агенту увидеть результат всех изменений
- Если передан только `card_id` без других полей, можно либо вернуть ошибку валидации, либо отправить пустой PATCH (валидно, вернёт текущую карточку)
