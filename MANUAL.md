# Kaiten MCP Server — Руководство

## Быстрый старт

### 1. Установка

```bash
cd /home/happiest/pet/claude-test
npm install
```

### 2. Сборка

```bash
npm run build
```

### 3. Настройка

Нужны две переменные окружения:

| Переменная | Описание | Пример |
|------------|----------|--------|
| `KAITEN_API_TOKEN` | API-токен из профиля Kaiten | `abc123...` |
| `KAITEN_BASE_URL` | Полный URL API вашего Kaiten | `https://mycompany.kaiten.ru/api/latest` |

Токен создаётся в Kaiten: **Профиль → Настройки → API-токены**.

### 4. Запуск

```bash
KAITEN_API_TOKEN=ваш_токен KAITEN_BASE_URL=https://yourcompany.kaiten.ru/api/latest node dist/src/index.js
```

Сервер работает через stdio — он предназначен для подключения из MCP-клиента (Claude Code, Claude Desktop и т.д.).

---

## Подключение к Claude Code

Добавьте в `.mcp.json` вашего проекта или в `~/.claude/mcp.json`:

```json
{
  "mcpServers": {
    "kaiten": {
      "command": "node",
      "args": ["/home/happiest/pet/claude-test/dist/src/index.js"],
      "env": {
        "KAITEN_API_TOKEN": "ваш_токен",
        "KAITEN_BASE_URL": "https://yourcompany.kaiten.ru/api/latest"
      }
    }
  }
}
```

После этого Claude получит доступ ко всем tools.

---

## Реализованные tools

### get-task-details

Получает детальную информацию о задаче (карточке) в Kaiten: описание, метаданные, исполнителей и комментарии.

**Что возвращает:**
- **Основные поля:** id, title, description, state (статус)
- **Участники:** owner (автор), responsible (исполнитель), members (участники)
- **Расположение:** board_id, column_id, lane_id
- **Метаданные:** tags, links (связи с другими картами)
- **Временные метки:** created_at, updated_at (ISO timestamps)
- **Комментарии** (если include_comments=true): массив с полями text, author_id, created_at, updated_at

**Пагинация комментариев:**
- `comments_limit`: количество комментариев на запрос (по умолчанию 20, максимум 100)
- `comments_offset`: начать с N-го комментария (для получения следующих страниц)
- `has_more` в ответе: true если есть ещё комментарии
- Пример: offset=0, limit=20 → первые 20; offset=20, limit=20 → следующие 20

**Параметры:**

| Параметр | Тип | Обязательный | По умолчанию | Описание |
|----------|-----|--------------|--------------|----------|
| `card_id` | number | да | — | ID карточки в Kaiten |
| `include_comments` | boolean | нет | `true` | Загружать комментарии |
| `comments_limit` | number | нет | `20` | Комментариев на странице (1-100) |
| `comments_offset` | number | нет | `0` | Смещение для пагинации |

**Пример запроса:**
```json
{ "card_id": 12345 }
```

**Пример ответа:**
```json
{
  "card_id": 12345,
  "title": "Исправить баг в авторизации",
  "description": "Описание задачи в Markdown",
  "state": "active",
  "board_id": 10,
  "column_id": 101,
  "lane_id": null,
  "owner_id": 501,
  "members": [{ "id": 501, "full_name": "Иван Иванов" }],
  "tags": [{ "id": 1, "name": "bug" }],
  "created_at": "2026-02-01T10:00:00Z",
  "updated_at": "2026-02-10T14:30:00Z",
  "comments": {
    "items": [
      {
        "id": 301,
        "author_id": 502,
        "text": "Проверила — баг воспроизводится",
        "created_at": "2026-02-05T12:00:00Z",
        "updated_at": "2026-02-05T12:00:00Z"
      }
    ],
    "total": 1,
    "limit": 20,
    "offset": 0,
    "has_more": false
  }
}
```

---

### get-time-logs

Получает логи учёта времени по задаче (карточке) в Kaiten. Возвращает записи о потраченном времени с разбивкой по пользователям и дням, а также суммарное время.

**Формат времени:**
- Все значения `time_spent` и `total_minutes` в **минутах** (целые числа)
- Пример: 120 минут = 2 часа, 480 минут = 8 часов (рабочий день)

**Режимы группировки (group_by):**

1. **"none"** (по умолчанию) — плоский список всех записей:
   - `{ card_id, total_minutes, entries: [{ id, user_id, author_id, time_spent, for_date, comment, created_at }, ...] }`

2. **"user"** — группировка по пользователям:
   - `{ card_id, total_minutes, by_user: [{ user_id, total_minutes, entries: [...] }, ...] }`
   - Полезно для ответа "сколько времени потратил каждый участник"

3. **"date"** — группировка по дням:
   - `{ card_id, total_minutes, by_date: [{ for_date, total_minutes, entries: [...] }, ...] }`
   - Полезно для временных отчётов и анализа динамики

**Параметры:**

| Параметр | Тип | Обязательный | По умолчанию | Описание |
|----------|-----|--------------|--------------|----------|
| `card_id` | number | да | — | ID карточки |
| `group_by` | `"none"` \| `"user"` \| `"date"` | нет | `"none"` | Группировка результатов |

**Пример запроса:**
```json
{ "card_id": 12345, "group_by": "user" }
```

**Пример ответа (group_by: "none"):**
```json
{
  "card_id": 12345,
  "total_minutes": 270,
  "entries": [
    {
      "id": 1,
      "user_id": 501,
      "author_id": 501,
      "time_spent": 120,
      "for_date": "2026-02-10",
      "comment": "Рефакторинг модуля авторизации",
      "created_at": "2026-02-10T16:00:00Z"
    }
  ]
}
```

**Пример ответа (group_by: "user"):**
```json
{
  "card_id": 12345,
  "total_minutes": 270,
  "by_user": [
    {
      "user_id": 501,
      "total_minutes": 180,
      "entries": [...]
    }
  ]
}
```

---

### get-task-status

Получает текущий статус задачи (карточки) в Kaiten по ID. Поддерживает запрос статусов нескольких задач за один вызов (до 50).

**Формат ответа:**
Массив объектов, каждый содержит:
- `card_id`, `title`, `board_id`, `column_id`
- `state`: строка состояния (см. маппинг ниже)
- `updated_at`: ISO timestamp последнего обновления
- `error`: строка ошибки (если карточка не найдена или недоступна)

**Маппинг состояний (state):**
- `"active"` — карточка активна (state=1 в API)
- `"unknown_N"` — неизвестное состояние (где N — код из API)

**Обработка ошибок:**
- Если карточка не найдена → объект с полем `error` вместо `title`/`state`
- Ошибка авторизации (401) → прерывает запрос для всех карточек
- Запросы выполняются параллельно. Ненайденные карточки возвращаются с полем `error`, не блокируя остальные.

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `card_ids` | number[] | да | Массив ID карточек (1-50) |

**Пример запроса:**
```json
{ "card_ids": [12345, 12346, 99999] }
```

**Пример ответа (частичный успех):**
```json
[
  {
    "card_id": 12345,
    "title": "Исправить баг в авторизации",
    "board_id": 10,
    "column_id": 101,
    "state": "active",
    "updated_at": "2026-02-10T14:30:00Z"
  },
  {
    "card_id": 12346,
    "title": "Добавить пагинацию",
    "board_id": 10,
    "column_id": 102,
    "state": "active",
    "updated_at": "2026-02-09T18:00:00Z"
  },
  {
    "card_id": 99999,
    "error": "Карточка не найдена"
  }
]
```

---

### create-task

Создаёт новую задачу (карточку) в Kaiten. Обязательные поля: `title`, `board_id`, `column_id`.

**Практические советы:**
- **description**: используйте plain text с переносами строк (`\n`), НЕ используйте markdown-заголовки (#, ##)
- **Структура описания**: введение → детали → контекст/связи
- **title**: краткий и понятный заголовок (1-500 символов)
- **position**: 1 = в начало колонки (для срочных задач), 2 = в конец (по умолчанию)

**Примеры:**
- `title="Исправить баг авторизации"`
- `description="Пользователи не могут войти через OAuth.\n\nШаги воспроизведения:\n1. Открыть страницу логина\n2. Нажать \"Войти через Google\"\n3. Ошибка 500\n\nОжидается: успешный вход"`

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `title` | string | да | Заголовок (1-500 символов) |
| `board_id` | number | да | ID доски |
| `column_id` | number | да | ID колонки |
| `description` | string | нет | Описание в plain text (до 50000 символов) |
| `lane_id` | number | нет | ID дорожки (lane) |
| `position` | `1` \| `2` | нет | 1 = в начало, 2 = в конец колонки |
| `tags` | number[] | нет | ID тегов (до 20) |

**Пример запроса:**
```json
{
  "title": "Добавить валидацию email",
  "board_id": 10,
  "column_id": 100
}
```

**Пример ответа:**
```json
{
  "card_id": 12350,
  "title": "Добавить валидацию email",
  "board_id": 10,
  "column_id": 100,
  "lane_id": null,
  "state": "active",
  "created_at": "2026-02-11T10:00:00Z"
}
```

---

## Общие ошибки

| Ситуация | Сообщение |
|----------|-----------|
| Карточка не найдена | `Карточка не найдена` |
| Неверный токен | `Ошибка авторизации. Проверьте KAITEN_API_TOKEN` |
| Нет доступа | `Нет доступа к карточке` |
| Таймаут (>30с) | `Превышено время ожидания ответа от Kaiten API` |

---

## Ручное тестирование

### Способ 1: Через Claude Code

1. Соберите проект: `npm run build`
2. Добавьте конфиг в `.mcp.json` (см. выше)
3. Перезапустите Claude Code
4. Спросите: *"Покажи информацию по задаче 12345 в Kaiten"*

### Способ 2: Через MCP Inspector

```bash
KAITEN_API_TOKEN=ваш_токен KAITEN_BASE_URL=https://yourcompany.kaiten.ru/api/latest \
  npx @modelcontextprotocol/inspector node dist/src/index.js
```

Откроется веб-интерфейс для вызова tools.

### Способ 3: Юнит-тесты

```bash
npm test
```

Запустит 58 тестов (без реальных HTTP-запросов — всё замокано).

---

## Где взять card_id?

Откройте карточку в Kaiten — ID виден в URL:
```
https://yourcompany.kaiten.ru/space/123/boards/10/cards/12345
                                                        ^^^^^
                                                       card_id
```
